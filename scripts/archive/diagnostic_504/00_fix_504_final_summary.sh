#!/usr/bin/env bash
set -e

echo "=============================================================="
echo " [KeyBuzz] R√©sum√© Corrections 504 Intermittent"
echo "=============================================================="
echo ""

echo "‚úÖ Corrections appliqu√©es:"
echo ""
echo "1. Timeouts augment√©s:"
echo "   - proxy-connect-timeout: 180s"
echo "   - proxy-send-timeout: 180s"
echo "   - proxy-read-timeout: 180s"
echo ""
echo "2. Retries configur√©s:"
echo "   - proxy-next-upstream-tries: 5"
echo "   - proxy-next-upstream: error timeout http_502 http_503"
echo ""
echo "3. Keepalive optimis√©:"
echo "   - upstream-keepalive-connections: 64"
echo "   - upstream-keepalive-timeout: 60s"
echo "   - upstream-keepalive-requests: 100"
echo ""
echo "4. SessionAffinity activ√©:"
echo "   - Services: ClientIP (3h)"
echo ""
echo "5. ConfigMap Ingress:"
echo "   - Timeouts globaux configur√©s"
echo ""

echo "=============================================================="
echo " ‚ö†Ô∏è  Points d'attention"
echo "=============================================================="
echo ""
echo "1. Load Balancer Hetzner:"
echo "   - V√©rifiez que les healthchecks sont configur√©s correctement"
echo "   - Interval: 10-15 secondes"
echo "   - Timeout: 5-10 secondes"
echo "   - Unhealthy threshold: 3"
echo "   - Healthy threshold: 2"
echo ""
echo "2. DNS Resolution:"
echo "   - CoreDNS fonctionne mais peut √™tre lent parfois"
echo "   - Les timeouts augment√©s compensent cela"
echo ""
echo "3. Tests depuis l'ext√©rieur:"
echo "   - Les requ√™tes r√©elles fonctionnent (voir logs)"
echo "   - Les tests internes peuvent timeout (normal avec timeouts longs)"
echo ""

echo "=============================================================="
echo " üìã V√©rifications √† faire"
echo "=============================================================="
echo ""
echo "1. Testez depuis votre navigateur:"
echo "   - https://platform.keybuzz.io"
echo "   - https://platform-api.keybuzz.io"
echo ""
echo "2. Si erreurs 504 persistent:"
echo "   - V√©rifiez les healthchecks du LB Hetzner"
echo "   - Augmentez les timeouts du LB si n√©cessaire"
echo "   - V√©rifiez les logs Ingress: kubectl logs -n ingress-nginx <pod>"
echo ""
echo "3. Monitoring:"
echo "   - Surveillez les logs des pods KeyBuzz"
echo "   - Surveillez les m√©triques Ingress Controller"
echo ""

echo "=============================================================="
echo " ‚úÖ Configuration finale"
echo "=============================================================="
echo ""
kubectl get ingress -n keybuzz -o yaml | grep -A 5 'annotations:' | grep -E 'proxy|upstream|keepalive' | head -10
echo ""
kubectl get svc -n keybuzz -o yaml | grep -A 3 'sessionAffinity' | head -6
echo ""

