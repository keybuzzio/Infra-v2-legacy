#!/usr/bin/env bash
#
# 10_keybuzz_01_deploy_api.sh - Déploiement KeyBuzz API
#
# Ce script déploie l'API KeyBuzz sur le cluster K3s avec :
# - Deployment avec 3 réplicas
# - HPA (min: 3, max: 30)
# - Service ClusterIP
# - Secrets Kubernetes pour les credentials
# - Affinity pour éviter worker IA et monitoring
#
# Usage:
#   ./10_keybuzz_01_deploy_api.sh [servers.tsv]
#
# Prérequis:
#   - Module 9 installé (K3s HA)
#   - Module 10 script 00 exécuté (credentials)
#   - Exécuter depuis install-01

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INSTALL_DIR="$(cd "${SCRIPT_DIR}/../.." && pwd)"
TSV_FILE="${1:-${INSTALL_DIR}/servers.tsv}"
CREDENTIALS_DIR="${INSTALL_DIR}/credentials"
CREDENTIALS_FILE="${CREDENTIALS_DIR}/keybuzz.env"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[✓]${NC} $1"
}

log_error() {
    echo -e "${RED}[✗]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[!]${NC} $1"
}

# Vérifier les prérequis
if [[ ! -f "${TSV_FILE}" ]]; then
    log_error "Fichier servers.tsv introuvable: ${TSV_FILE}"
    exit 1
fi

if [[ ! -f "${CREDENTIALS_FILE}" ]]; then
    log_error "Fichier credentials introuvable: ${CREDENTIALS_FILE}"
    log_error "Exécutez d'abord: ./10_keybuzz_00_setup_credentials.sh"
    exit 1
fi

# Charger les credentials
source "${CREDENTIALS_FILE}"

# Détecter la clé SSH
SSH_KEY_OPTS=""
if [[ -f "${HOME}/.ssh/keybuzz_infra" ]]; then
    SSH_KEY_OPTS="-i ${HOME}/.ssh/keybuzz_infra"
elif [[ -f "${HOME}/.ssh/id_ed25519" ]]; then
    SSH_KEY_OPTS="-i ${HOME}/.ssh/id_ed25519"
elif [[ -f "${HOME}/.ssh/id_rsa" ]]; then
    SSH_KEY_OPTS="-i ${HOME}/.ssh/id_rsa"
fi

# Header
echo "=============================================================="
echo " [KeyBuzz] Module 10 - Déploiement KeyBuzz API"
echo "=============================================================="
echo ""

# Trouver le premier master K3s
declare -a K3S_MASTER_IPS=()

exec 3< "${TSV_FILE}"
while IFS=$'\t' read -r ENV IP_PUBLIQUE HOSTNAME IP_PRIVEE FQDN USER_SSH POOL ROLE SUBROLE DOCKER_STACK CORE NOTES <&3; do
    if [[ "${ENV}" == "ENV" ]]; then
        continue
    fi
    
    if [[ "${ENV}" != "prod" ]]; then
        continue
    fi
    
    if [[ "${ROLE}" == "k3s" ]] && [[ "${SUBROLE}" == "master" ]] && [[ -n "${IP_PRIVEE}" ]]; then
        K3S_MASTER_IPS+=("${IP_PRIVEE}")
    fi
done
exec 3<&-

if [[ ${#K3S_MASTER_IPS[@]} -lt 1 ]]; then
    log_error "Aucun master K3s trouvé"
    exit 1
fi

MASTER_IP="${K3S_MASTER_IPS[0]}"
log_info "Utilisation du master: ${MASTER_IP}"

# Vérifier la connectivité au cluster
log_info "Vérification de la connectivité au cluster K3s..."
if ! ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl get nodes" > /dev/null 2>&1; then
    log_error "Impossible de se connecter au cluster K3s"
    exit 1
fi
log_success "Cluster K3s accessible"

# Créer le namespace si nécessaire
log_info "Création du namespace keybuzz..."
ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl create namespace keybuzz --dry-run=client -o yaml | kubectl apply -f -" > /dev/null 2>&1
log_success "Namespace keybuzz prêt"

# Créer le Secret Kubernetes avec les credentials
log_info "Création du Secret Kubernetes pour KeyBuzz API..."

SECRET_YAML=$(cat <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: keybuzz-api-secrets
  namespace: keybuzz
type: Opaque
stringData:
  DATABASE_URL: "${DATABASE_URL}"
  REDIS_URL: "${REDIS_URL}"
  RABBITMQ_URL: "${RABBITMQ_URL}"
  MINIO_URL: "${MINIO_URL}"
  VECTOR_URL: "${VECTOR_URL}"
  LLM_URL: "${LLM_URL}"
EOF
)

echo "${SECRET_YAML}" | ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl apply -f -" > /dev/null 2>&1
log_success "Secret keybuzz-api-secrets créé"

# Image Docker pour KeyBuzz API
# Par défaut, on utilise une image placeholder pour tester la configuration
# Remplacez par votre image réelle une fois construite
KEYBUZZ_API_IMAGE="${KEYBUZZ_API_IMAGE:-nginx:alpine}"
KEYBUZZ_API_PORT="${KEYBUZZ_API_PORT:-8080}"

log_warning "⚠️  Image Docker: ${KEYBUZZ_API_IMAGE}"
log_warning "⚠️  NOTE: Utilisez une image placeholder pour tester la configuration"
log_warning "⚠️  Remplacez par votre image KeyBuzz API une fois construite"
log_info "Port: ${KEYBUZZ_API_PORT}"

# Créer le Deployment KeyBuzz API
log_info "Création du Deployment KeyBuzz API..."

DEPLOYMENT_YAML=$(cat <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: keybuzz-api
  namespace: keybuzz
  labels:
    app: keybuzz-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: keybuzz-api
  template:
    metadata:
      labels:
        app: keybuzz-api
    spec:
      # Affinity: Éviter worker IA (#3) et monitoring heavy
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: node-role.kubernetes.io/worker
                operator: In
                values:
                - ""
          - weight: 50
            preference:
              matchExpressions:
              - key: kubernetes.io/hostname
                operator: NotIn
                values:
                - k3s-worker-03  # Worker IA
                - k3s-worker-04  # Monitoring
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - keybuzz-api
              topologyKey: kubernetes.io/hostname
      containers:
      - name: keybuzz-api
        image: ${KEYBUZZ_API_IMAGE}
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: ${KEYBUZZ_API_PORT}
          name: http
          protocol: TCP
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: keybuzz-api-secrets
              key: DATABASE_URL
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: keybuzz-api-secrets
              key: REDIS_URL
        - name: RABBITMQ_URL
          valueFrom:
            secretKeyRef:
              name: keybuzz-api-secrets
              key: RABBITMQ_URL
        - name: MINIO_URL
          valueFrom:
            secretKeyRef:
              name: keybuzz-api-secrets
              key: MINIO_URL
        - name: VECTOR_URL
          valueFrom:
            secretKeyRef:
              name: keybuzz-api-secrets
              key: VECTOR_URL
        - name: LLM_URL
          valueFrom:
            secretKeyRef:
              name: keybuzz-api-secrets
              key: LLM_URL
        - name: PORT
          value: "${KEYBUZZ_API_PORT}"
        # Healthchecks désactivés pour image placeholder
        # Décommentez une fois votre image KeyBuzz API est prête
        # livenessProbe:
        #   httpGet:
        #     path: /health
        #     port: ${KEYBUZZ_API_PORT}
        #   initialDelaySeconds: 30
        #   periodSeconds: 10
        #   timeoutSeconds: 5
        #   failureThreshold: 3
        # readinessProbe:
        #   httpGet:
        #     path: /health
        #     port: ${KEYBUZZ_API_PORT}
        #   initialDelaySeconds: 10
        #   periodSeconds: 5
        #   timeoutSeconds: 3
        #   failureThreshold: 3
        resources:
          requests:
            cpu: "200m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "2Gi"
EOF
)

echo "${DEPLOYMENT_YAML}" | ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl apply -f -" > /dev/null 2>&1
log_success "Deployment keybuzz-api créé"

# Créer le Service
log_info "Création du Service keybuzz-api..."

SERVICE_YAML=$(cat <<EOF
apiVersion: v1
kind: Service
metadata:
  name: keybuzz-api
  namespace: keybuzz
  labels:
    app: keybuzz-api
spec:
  type: ClusterIP
  selector:
    app: keybuzz-api
  ports:
  - port: 80
    targetPort: ${KEYBUZZ_API_PORT}
    protocol: TCP
    name: http
EOF
)

echo "${SERVICE_YAML}" | ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl apply -f -" > /dev/null 2>&1
log_success "Service keybuzz-api créé"

# Créer le HorizontalPodAutoscaler
log_info "Création du HPA (min: 3, max: 30)..."

HPA_YAML=$(cat <<EOF
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: keybuzz-api-hpa
  namespace: keybuzz
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: keybuzz-api
  minReplicas: 3
  maxReplicas: 30
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 30
      - type: Pods
        value: 2
        periodSeconds: 30
      selectPolicy: Max
EOF
)

echo "${HPA_YAML}" | ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl apply -f -" > /dev/null 2>&1
log_success "HPA keybuzz-api-hpa créé"

# Attendre que les pods soient prêts
log_info "Attente du démarrage des pods (30 secondes)..."
sleep 30

# Vérifier le statut
log_info "Vérification du statut du déploiement..."
ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl get deployment keybuzz-api -n keybuzz"
echo ""
ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl get pods -n keybuzz -l app=keybuzz-api"
echo ""
ssh ${SSH_KEY_OPTS} "root@${MASTER_IP}" "kubectl get hpa keybuzz-api-hpa -n keybuzz"

echo ""
echo "=============================================================="
log_success "✅ KeyBuzz API déployé"
echo "=============================================================="
echo ""
log_info "Configuration:"
log_info "  - Namespace: keybuzz"
log_info "  - Deployment: keybuzz-api (3 réplicas)"
log_info "  - Service: keybuzz-api (ClusterIP)"
log_info "  - HPA: min=3, max=30"
log_info "  - Image: ${KEYBUZZ_API_IMAGE}"
echo ""
log_info "Prochaine étape: ./10_keybuzz_02_deploy_front.sh"
echo ""

